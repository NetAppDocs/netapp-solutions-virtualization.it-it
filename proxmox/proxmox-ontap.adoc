---
sidebar: sidebar 
permalink: proxmox/proxmox-ontap.html 
keywords: netapp, proxmox, proxmox ve, all-flash, nfs, iscsi, ontap, storage, aff 
summary: 'L"archiviazione condivisa in Proxmox Virtual Environment (VE) riduce i tempi di migrazione live delle VM e costituisce un obiettivo migliore per i backup e modelli coerenti in tutto l"ambiente.  L"archiviazione ONTAP può soddisfare le esigenze degli ambienti host Proxmox VE nonché le richieste di archiviazione di file, blocchi e oggetti guest.' 
---
= Fornire storage ONTAP per l'ambiente virtuale Proxmox
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Configurare l'archiviazione ONTAP con Proxmox Virtual Environment (VE) utilizzando i protocolli NAS, SAN e SMB/CIFS.  L'archiviazione condivisa in Proxmox VE riduce i tempi di migrazione delle VM live e fornisce un obiettivo migliore per il backup e modelli coerenti in tutto l'ambiente.

Gli host Proxmox VE devono disporre di interfacce FC, Ethernet o altre interfacce supportate cablate agli switch e di comunicazione con le interfacce logiche ONTAP .  Controllare sempre https://mysupport.netapp.com/matrix/#welcome["Strumento di matrice di interoperabilità"] per le configurazioni supportate.



== Funzionalità ONTAP di alto livello

*Caratteristiche comuni*

* Cluster scalabile
* Autenticazione sicura e supporto RBAC
* Supporto multi-amministratore Zero Trust
* Multitenancy sicura
* Replica i dati con SnapMirror.
* Copie puntuali con snapshot.
* Cloni efficienti in termini di spazio.
* Funzionalità di efficienza di archiviazione come deduplicazione, compressione, ecc.
* Supporto Trident CSI per Kubernetes
* Chiusura a scatto
* Blocco delle copie snapshot a prova di manomissione
* Supporto per la crittografia
* FabricPool suddivide i dati inattivi in livelli per l'archivio oggetti.
* Integrazione BlueXP e CloudInsights.
* Trasferimento dati scaricato da Microsoft (ODX)


*NAS*

* I volumi FlexGroup sono un contenitore NAS scalabile che garantisce elevate prestazioni insieme a distribuzione del carico e scalabilità.
* FlexCache consente di distribuire i dati a livello globale e fornisce comunque accesso locale in lettura e scrittura ai dati.
* Il supporto multiprotocollo consente di accedere agli stessi dati tramite SMB e NFS.
* NFS nConnect consente più sessioni TCP per connessione TCP, aumentando la produttività della rete.  Ciò aumenta l'utilizzo delle schede di rete ad alta velocità disponibili sui server moderni.
* Il trunking delle sessioni NFS garantisce maggiori velocità di trasferimento dati, elevata disponibilità e tolleranza agli errori.
* La tecnologia SMB multicanale garantisce una maggiore velocità di trasferimento dati, elevata disponibilità e tolleranza agli errori.
* Integrazione con Active Directory/LDAP per i permessi dei file.
* Connessione sicura con NFS su TLS.
* Supporto NFS Kerberos.
* NFS su RDMA.
* Mappatura dei nomi tra identità Windows e Unix.
* Protezione autonoma contro i ransomware.
* Analisi del file system.


*SAN*

* Estendi il cluster su domini di errore con SnapMirror ActiveSync.
* I modelli ASA forniscono multipathing attivo/attivo e failover rapido del percorso.
* Supporto per i protocolli FC, iSCSI, NVMe-oF.
* Supporto per l'autenticazione reciproca iSCSI CHAP.
* Mappa LUN selettiva e Portset.




== Tipi di archiviazione Proxmox VE supportati con ONTAP

I protocolli NAS (NFS/SMB) supportano tutti i tipi di contenuto di Proxmox VE e vengono in genere configurati una sola volta a livello di data center.  Le VM guest possono utilizzare dischi di tipo raw, qcow2 o VMDK su storage NAS.  È possibile rendere visibili gli snapshot ONTAP per accedere a copie puntuali dei dati dal client.  L'archiviazione a blocchi con protocolli SAN (FC/iSCSI/NVMe-oF) è in genere configurata per ogni host ed è limitata ai tipi di contenuto VM Disk e Container Image supportati da Proxmox VE.  Le VM guest e i container utilizzano lo storage a blocchi come dispositivi raw.

[cols="25% 15% 15% 15% 15% 15%"]
|===
| Tipo di contenuto | NFS | PMI/CIFS | FC | iSCSI | NVMe-oF 


| Backup | SÌ | SÌ  a| 
No^1^
 a| 
No^1^
 a| 
No^1^



| Dischi VM | SÌ | SÌ  a| 
Sì^2^
 a| 
Sì^2^
 a| 
Sì^2^



| Volumi TC | SÌ | SÌ  a| 
Sì^2^
 a| 
Sì^2^
 a| 
Sì^2^



| Immagini ISO | SÌ | SÌ  a| 
No^1^
 a| 
No^1^
 a| 
No^1^



| Modelli CT | SÌ | SÌ  a| 
No^1^
 a| 
No^1^
 a| 
No^1^



| Frammenti | SÌ | SÌ  a| 
No^1^
 a| 
No^1^
 a| 
No^1^

|===
*Note:* 1 - Richiede il file system del cluster per creare la cartella condivisa e utilizzare il tipo di archiviazione Directory.  2 - utilizzare il tipo di archiviazione LVM.



== Archiviazione SMB/CIFS

Per utilizzare le condivisioni file SMB/CIFS, l'amministratore dello storage deve eseguire determinate attività, mentre l'amministratore della virtualizzazione può montare la condivisione utilizzando l'interfaccia utente di Proxmox VE o dalla shell.  La tecnologia SMB multicanale garantisce tolleranza agli errori e aumenta le prestazioni.  Per maggiori dettagli, fare riferimento alink:https://www.netapp.com/pdf.html?item=/media/17136-tr4740.pdf["TR4740 - SMB 3.0 Multicanale"]


NOTE: La password verrà salvata in un file di testo normale e sarà accessibile solo all'utente root. Fare riferimento a link:https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_cifs["Documentazione Proxmox VE"] .

.Pool di archiviazione condiviso SMB con ONTAP
video::5b4ae54a-08d2-4f7d-95ec-b22d015f6035[panopto,width=360]
.<strong>Attività di amministrazione dell'archiviazione</strong>
[%collapsible%open]
====
Se non hai familiarità con ONTAP, utilizza l'interfaccia System Manager per completare queste attività e ottenere un'esperienza migliore.

. Assicurarsi che SVM sia abilitato per SMB.  Seguirelink:https://docs.netapp.com/us-en/ontap/smb-config/configure-access-svm-task.html["Documentazione ONTAP 9"] per maggiori informazioni.
. Avere almeno due ascensori per controller.  Seguire i passaggi indicati nel link sopra.  Per riferimento, ecco uno screenshot di lifs utilizzato in questa soluzione.
+
image:proxmox-ontap-001.png["dettagli dell'interfaccia NAS"]

. Utilizzare l'autenticazione basata su Active Directory o sul gruppo di lavoro.  Seguire i passaggi indicati nel link sopra.
+
image:proxmox-ontap-002.png["Unisciti alle informazioni del dominio"]

. Crea un volume.  Ricordarsi di selezionare l'opzione per distribuire i dati nel cluster per utilizzare FlexGroup.
+
image:proxmox-ontap-023.png["Opzione FlexGroup"]

. Crea una condivisione SMB e modifica le autorizzazioni.  Seguirelink:https://docs.netapp.com/us-en/ontap/smb-config/configure-client-access-shared-storage-concept.html["Documentazione ONTAP 9"] per maggiori informazioni.
+
image:proxmox-ontap-003.png["Informazioni sulle quote di SMB"]

. Fornire il server SMB, il nome della condivisione e le credenziali all'amministratore della virtualizzazione affinché possa completare l'attività.


====
.<strong>Attività di amministrazione della virtualizzazione</strong>
[%collapsible%open]
====
. Raccogli il server SMB, il nome della condivisione e le credenziali da utilizzare per l'autenticazione della condivisione.
. Assicurarsi che almeno due interfacce siano configurate in VLAN diverse (per tolleranza agli errori) e che la scheda di rete supporti RSS.
. Se si utilizza l'interfaccia utente di gestione `https:<proxmox-node>:8006` , fare clic su datacenter, selezionare storage, fare clic su Aggiungi e selezionare SMB/CIFS.
+
image:proxmox-ontap-004.png["Navigazione nell'archiviazione SMB"]

. Compila i dettagli e il nome della condivisione dovrebbe comparire automaticamente.  Assicurati che tutti i contenuti siano selezionati.  Fare clic su Aggiungi.
+
image:proxmox-ontap-005.png["Aggiunta di spazio di archiviazione SMB"]

. Per abilitare l'opzione multicanale, vai alla shell su uno qualsiasi dei nodi del cluster e digita pvesm set pvesmb01 --options multichannel,max_channels=4
+
image:proxmox-ontap-006.png["configurazione multicanale"]

. Ecco il contenuto di /etc/pve/storage.cfg per le attività sopra descritte.
+
image:proxmox-ontap-007.png["file di configurazione dell'archiviazione per SMB"]



====


== Archiviazione NFS

ONTAP supporta tutte le versioni NFS supportate da Proxmox VE.  Per garantire tolleranza agli errori e miglioramenti delle prestazioni, assicurarsilink:https://docs.netapp.com/us-en/ontap/nfs-trunking/index.html["troncamento di sessione"] viene utilizzato.  Per utilizzare il trunking di sessione, è richiesta almeno la versione NFS v4.1.

Se non hai familiarità con ONTAP, utilizza l'interfaccia System Manager per completare queste attività e ottenere un'esperienza migliore.

.Opzione NFS nconnect con ONTAP
video::f6c9aba3-b070-45d6-8048-b22e001acfd4[panopto,width=360]
.<strong>Attività di amministrazione dell'archiviazione</strong>
[%collapsible%open]
====
. Assicurarsi che SVM sia abilitato per NFS. Fare riferimento a link:https://docs.netapp.com/us-en/ontap/nfs-config/verify-protocol-enabled-svm-task.html["Documentazione ONTAP 9"]
. Avere almeno due ascensori per controller.  Seguire i passaggi indicati nel link sopra.  Per riferimento, ecco lo screenshot dei lif che utilizziamo nel nostro laboratorio.
+
image:proxmox-ontap-001.png["dettagli dell'interfaccia NAS"]

. Crea o aggiorna i criteri di esportazione NFS che forniscono l'accesso agli indirizzi IP dell'host Proxmox VE o alla subnet. Fare riferimento alink:https://docs.netapp.com/us-en/ontap/nfs-config/create-export-policy-task.html["Creazione di politiche di esportazione"] Elink:https://docs.netapp.com/us-en/ontap/nfs-config/add-rule-export-policy-task.html["Aggiungi regola a un criterio di esportazione"] .
. link:https://docs.netapp.com/us-en/ontap/nfs-config/create-volume-task.html["Crea un volume"] . Ricordarsi di selezionare l'opzione per distribuire i dati nel cluster per utilizzare FlexGroup.
+
image:proxmox-ontap-023.png["Opzione FlexGroup"]

. link:https://docs.netapp.com/us-en/ontap/nfs-config/associate-export-policy-flexvol-task.html["Assegna la politica di esportazione al volume"]
+
image:proxmox-ontap-008.png["Informazioni sul volume NFS"]

. Notifica all'amministratore della virtualizzazione che il volume NFS è pronto.


====
.<strong>Attività di amministrazione della virtualizzazione</strong>
[%collapsible%open]
====
. Assicurarsi che almeno due interfacce siano configurate in VLAN diverse (per la tolleranza agli errori).  Utilizzare il bonding NIC.
. Se si utilizza l'interfaccia utente di gestione `https:<proxmox-node>:8006` , fare clic su datacenter, selezionare storage, fare clic su Aggiungi e selezionare NFS.
+
image:proxmox-ontap-009.png["Navigazione nell'archiviazione NFS"]

. Compila i dettagli. Dopo aver fornito le informazioni sul server, le esportazioni NFS dovrebbero essere popolate e selezionate dall'elenco.  Ricordatevi di selezionare le opzioni del contenuto.
+
image:proxmox-ontap-010.png["Aggiunta di archiviazione NFS"]

. Per il trunking di sessione, su ogni host Proxmox VE, aggiornare il file /etc/fstab per montare la stessa esportazione NFS utilizzando un indirizzo lif diverso insieme all'opzione max_connect e alla versione NFS.
+
image:proxmox-ontap-011.png["voci fstab per il trunk della sessione"]

. Ecco il contenuto in /etc/pve/storage.cfg per NFS.
+
image:proxmox-ontap-012.png["file di configurazione di archiviazione per NFS"]



====


== LVM con iSCSI

.Pool condiviso LVM con iSCSI tramite ONTAP
video::d66ef67f-bcc2-4ced-848e-b22e01588e8c[panopto,width=360]
Per configurare Logical Volume Manager per l'archiviazione condivisa tra gli host Proxmox, completare le seguenti attività:

.<strong>Attività di amministrazione della virtualizzazione</strong>
[%collapsible%open]
====
. Assicurarsi che siano disponibili due interfacce VLAN Linux.
. Assicurarsi che multipath-tools sia installato su tutti gli host Proxmox VE.  Assicurarsi che si avvii all'avvio.
+
[source, shell]
----
apt list | grep multipath-tools
# If need to install, execute the following line.
apt-get install multipath-tools
systemctl enable multipathd
----
. Raccogliere l'IQN dell'host ISCSI per tutti gli host Proxmox VE e fornirlo all'amministratore dell'archiviazione.
+
[source, shell]
----
cat /etc/iscsi/initiator.name
----


====
.<strong>Attività di amministrazione dell'archiviazione</strong>
[%collapsible%open]
====
Se non hai familiarità con ONTAP, utilizza System Manager per un'esperienza migliore.

. Assicurarsi che SVM sia disponibile con il protocollo iSCSI abilitato.  Seguirelink:https://docs.netapp.com/us-en/ontap/san-admin/provision-storage.html["Documentazione ONTAP 9"]
. Disporre di due lif per controller dedicati per iSCSI.
+
image:proxmox-ontap-013.png["dettagli dell'interfaccia iscsi"]

. Creare igroup e popolare gli iniziatori iscsi dell'host.
. Creare la LUN con le dimensioni desiderate sulla SVM e presentarla all'igroup creato nel passaggio precedente.
+
image:proxmox-ontap-014.png["dettagli lun iscsi"]

. Notifica all'amministratore della virtualizzazione che la LUN è stata creata.


====
.<strong>Attività di amministrazione della virtualizzazione</strong>
[%collapsible%open]
====
. Vai all'interfaccia utente di gestione `https:<proxmox node>:8006` , fare clic su datacenter, selezionare storage, fare clic su Aggiungi e selezionare iSCSI.
+
image:proxmox-ontap-015.png["navigazione di archiviazione iscsi"]

. Fornire il nome dell'ID di archiviazione.  L'indirizzo iSCSI lif di ONTAP dovrebbe essere in grado di selezionare la destinazione quando non ci sono problemi di comunicazione.  Poiché la nostra intenzione è di non fornire direttamente l'accesso LUN alla macchina virtuale guest, deseleziona questa opzione.
+
image:proxmox-ontap-016.png["creazione del tipo di archiviazione ISCSI"]

. Ora fai clic su Aggiungi e seleziona LVM.
+
image:proxmox-ontap-017.png["navigazione di archiviazione lvm"]

. Fornire il nome dell'ID di archiviazione, selezionare l'archiviazione di base che deve corrispondere all'archiviazione iSCSI creata nel passaggio precedente.  Selezionare la LUN per il volume di base.  Fornire il nome del gruppo di volumi.  Assicurati che sia selezionata l'opzione Condiviso.
+
image:proxmox-ontap-018.png["creazione di storage lvm"]

. Ecco un esempio di file di configurazione dell'archiviazione per LVM che utilizza un volume iSCSI.
+
image:proxmox-ontap-019.png["configurazione lvm iscsi"]



====


== LVM con NVMe/TCP

.Pool condiviso LVM con NVMe/TCP tramite ONTAP
video::80164fe4-06db-4c21-a25d-b22e0179c3d2[panopto,width=360]
Per configurare Logical Volume Manager per l'archiviazione condivisa tra gli host Proxmox, completare le seguenti attività:

.<strong>Attività di amministrazione della virtualizzazione</strong>
[%collapsible%open]
====
. Assicurarsi che siano disponibili due interfacce VLAN Linux.
. Su ogni host Proxmox del cluster, eseguire il seguente comando per raccogliere le informazioni sull'iniziatore host.
+
[source, shell]
----
nvme show-hostnqn
----
. Fornire le informazioni nqn dell'host raccolte all'amministratore dell'archiviazione e richiedere uno spazio dei nomi nvme delle dimensioni richieste.


====
.<strong>Attività di amministrazione dell'archiviazione</strong>
[%collapsible%open]
====
Se non hai familiarità con ONTAP, utilizza System Manager per un'esperienza migliore.

. Assicurarsi che SVM sia disponibile con il protocollo NVMe abilitato.  Fare riferimentolink:https://docs.netapp.com/us-en/ontap/san-admin/create-nvme-namespace-subsystem-task.html["Documentazione sulle attività NVMe su ONTAP 9"] .
. Creare lo spazio dei nomi NVMe.
+
image:proxmox-ontap-020.png["creazione dello spazio dei nomi nvme"]

. Creare un sottosistema e assegnare gli host nqn (se si utilizza la CLI).  Seguire il link di riferimento sopra.
. Notifica all'amministratore della virtualizzazione che lo spazio dei nomi nvme è stato creato.


====
.<strong>Attività di amministrazione della virtualizzazione</strong>
[%collapsible%open]
====
. Passare alla shell su ciascun host Proxmox VE nel cluster e creare il file /etc/nvme/discovery.conf, quindi aggiornare il contenuto specifico per il proprio ambiente.
+
[source, shell]
----
root@pxmox01:~# cat /etc/nvme/discovery.conf
# Used for extracting default parameters for discovery
#
# Example:
# --transport=<trtype> --traddr=<traddr> --trsvcid=<trsvcid> --host-traddr=<host-traddr> --host-iface=<host-iface>

-t tcp -l 1800 -a 172.21.118.153
-t tcp -l 1800 -a 172.21.118.154
-t tcp -l 1800 -a 172.21.119.153
-t tcp -l 1800 -a 172.21.119.154
----
. Accedi al sottosistema nvme
+
[source, shell]
----
nvme connect-all
----
. Ispezionare e raccogliere i dettagli del dispositivo.
+
[source, shell]
----
nvme list
nvme netapp ontapdevices
nvme list-subsys
lsblk -l
----
. Crea gruppo di volumi
+
[source, shell]
----
vgcreate pvens02 /dev/mapper/<device id>
----
. Vai all'interfaccia utente di gestione `https:<proxmox node>:8006` , fare clic su datacenter, selezionare storage, fare clic su Aggiungi e selezionare LVM.
+
image:proxmox-ontap-017.png["navigazione di archiviazione lvm"]

. Fornire il nome dell'ID di archiviazione, scegliere il gruppo di volumi esistente e selezionare il gruppo di volumi appena creato con CLI.  Ricordatevi di selezionare l'opzione condivisa.
+
image:proxmox-ontap-021.png["lvm su vg esistente"]

. Ecco un file di configurazione di archiviazione di esempio per LVM utilizzando NVMe/TCP
+
image:proxmox-ontap-022.png["configurazione lvm su nvme tcp"]



====