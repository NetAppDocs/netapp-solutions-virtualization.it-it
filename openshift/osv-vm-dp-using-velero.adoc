---
sidebar: sidebar 
permalink: openshift/osv-vm-dp-using-velero.html 
keywords: OpenShift, OCP, Trident, NetApp ONTAP, Red Hat OpenShift, OpenShift Virtualization, CNV, Container Native Virtualization, Red Hat OpenShift Virtualization, OADP operator, Openshift Data Protection Application operator, velero 
summary: Virtualizzazione Red Hat OpenShift con NetApp ONTAP 
---
= Crea backup su richiesta per VM in Red Hat OpenShift Virtualization utilizzando Velero
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Eseguire il backup delle VM in OpenShift Virtualization utilizzando Velero e NetApp ONTAP S3 o StorageGRID.  Questa procedura include la creazione di risorse di backup personalizzate (CR) per i backup su richiesta e di CR pianificate per i backup pianificati.  Ogni backup acquisisce i metadati della VM e i volumi persistenti, archiviandoli nella posizione di archiviazione degli oggetti specificata per scopi di ripristino o conformità.



== Passaggi per creare un backup di una VM

Per creare un backup su richiesta dell'intera VM (metadati e dischi della VM), fare clic sulla scheda **Backup**.  In questo modo viene creata una risorsa personalizzata di backup (CR). Viene fornito un file yaml di esempio per creare il Backup CR.  Utilizzando questo yaml, verrà eseguito il backup della VM e dei suoi dischi nello spazio dei nomi specificato. È possibile impostare parametri aggiuntivi come mostrato inlink:https://docs.openshift.com/container-platform/4.14/backup_and_restore/application_backup_and_restore/backing_up_and_restoring/oadp-creating-backup-cr.html["documentazione"] .

Il CSI creerà uno snapshot dei volumi persistenti che supportano i dischi.  Un backup della VM insieme allo snapshot dei suoi dischi vengono creati e archiviati nella posizione di backup specificata nel file yaml. Il backup rimarrà nel sistema per 30 giorni, come specificato nel ttl.

....
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: backup1
  namespace: openshift-adp
spec:
  includedNamespaces:
  - virtual-machines-demo
  snapshotVolumes: true
  storageLocation: velero-demo-1 -->this is the backupStorageLocation previously created
                                    when Velero is configured.
  ttl: 720h0m0s
....
Una volta completato il backup, la relativa fase verrà visualizzata come completata.

image:redhat-openshift-oadp-backup-001.png["Backup completato"]

È possibile ispezionare il backup nell'archivio oggetti con l'ausilio di un'applicazione browser S3. Il percorso del backup viene visualizzato nel bucket configurato con il nome del prefisso (velero/demobackup).  È possibile visualizzare il contenuto del backup, inclusi gli snapshot del volume, i registri e altri metadati della macchina virtuale.


NOTE: In StorageGrid è anche possibile utilizzare la console S3 disponibile in Tenant Manager per visualizzare gli oggetti di backup.

image:redhat-openshift-oadp-backup-002.png["Backup degli oggetti in S3"]



== Creazione di backup pianificati per le VM in OpenShift Virtualization

Per creare backup pianificati, è necessario creare un CR pianificato. La pianificazione è semplicemente un'espressione Cron che consente di specificare l'ora in cui si desidera creare il backup. Un esempio di file YAML per creare una Schedule CR.

....
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: <schedule>
  namespace: openshift-adp
spec:
  schedule: 0 7 * * *
  template:
    hooks: {}
    includedNamespaces:
    - <namespace>
    storageLocation: velero-demo-1
    defaultVolumesToFsBackup: true
    ttl: 720h0m0s
....
L'espressione Cron 0 7 * * * significa che ogni giorno verrà creato un backup alle 7:00. Vengono inoltre specificati gli spazi dei nomi da includere nel backup e la posizione di archiviazione per il backup. Quindi, invece di un Backup CR, viene utilizzato il metodo Schedule CR per creare un backup all'ora e con la frequenza specificate.

Una volta creata, la pianificazione sarà abilitata.

image:redhat-openshift-oadp-backup-003.png["Programma creato"]

I backup verranno creati in base a questa pianificazione e potranno essere visualizzati nella scheda Backup.

image:redhat-openshift-oadp-backup-004.png["Programma creato"]
