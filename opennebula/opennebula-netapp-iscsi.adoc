---
sidebar: sidebar 
permalink: opennebula/opennebula-netapp-iscsi.html 
keywords: netapp, opennebula, opennebula, iscsi, snapshot, ontap, storage 
summary: Configura il datastore OpenNebula con iSCSI utilizzando ONTAP. Questa procedura include la configurazione iniziale richiesta per la connettività iSCSI e il provisioning del datastore. 
---
= Configura NetApp Datastore con iSCSI per OpenNebula
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Configura i datastore OpenNebula utilizzando il protocollo iSCSI con NetApp ONTAP in esecuzione su sistemi AFF o FAS. Questa configurazione consente l'accesso allo storage a livello di blocco su reti Ethernet standard con supporto multipath. Questa configurazione del datastore utilizza le funzionalità native di ONTAP, inclusi snapshot e clonazione, per migliorare l'efficienza dello storage e la protezione dei dati.



== Attività iniziali dell'amministratore della virtualizzazione

Completare queste attività iniziali per preparare gli host OpenNebula per la connettività iSCSI e raccogliere le informazioni necessarie per l'amministratore dello storage.

. Verificare che siano disponibili due interfacce VLAN Linux.
. Assicurarsi che multipath-tools e le utility iSCSI initiator siano installate su tutti gli host OpenNebula e che vengano avviate all'avvio.
+
[role="tabbed-block"]
====
.Debian/Ubuntu
--
[source, shell]
----
apt list | grep multipath-tools
# If need to install, execute the following line.
apt-get install multipath-tools open-iscsi
# If /etc/multipath.conf is not present, first make sure the multipathd service is started.
systemctl enable --now multipathd
systemctl enable --now open-iscsi
----
--
.RHEL/AlmaLinux
--
[source, shell]
----
dnf list installed | grep device-mapper-multipath
# If need to install, execute the following line.
dnf install device-mapper-multipath iscsi-initiator-utils
# If /etc/multipath.conf is not present, first make sure the multipathd service is started.
systemctl enable --now multipathd
systemctl enable --now iscsid
----
--
====
. Raccogli l'IQN host iSCSI per tutti gli host OpenNebula e fornisci queste informazioni all'amministratore dello storage.
+
[source, shell]
----
cat /etc/iscsi/initiator.name
----




== Attività dell'amministratore dell'archiviazione

Se non hai familiarità con ONTAP, utilizza System Manager per un'esperienza migliore.

. Assicurarsi che l'SVM sia disponibile con il protocollo iSCSI abilitato. Seguire link:https://docs.netapp.com/us-en/ontap/san-admin/provision-storage.html["Documentazione ONTAP 9"].
. Creare due LIF per controller dedicate per iSCSI. Si consigliano due LIF per controller per ridondanza e prestazioni multipath. Assicurarsi che le LIF vengano create sulle interfacce VLAN configurate sugli host OpenNebula. Si consigliano frame Jumbo (MTU 9000) per prestazioni migliori.
+
image:opennebula-netapp-iscsi-001.png["dettagli dell'interfaccia iscsi"]

. Crea un igroup e popola gli iSCSI initiator dell'host. Tipicamente viene creato un igroup per un OpenNebula cluster. Includi i server frontend e gli host hypervisor nello stesso igroup per supportare sia gli Image datastore che i System datastore.
. Creare un ruolo ONTAP e un account utente con accesso all'API REST ONTAP limitato alla SVM di destinazione. Questo utente verrà utilizzato dal driver NetApp in OpenNebula. Consultare la link:https://docs.netapp.com/us-en/ontap-automation/rest/rbac_overview.html["Lavorare con utenti e ruoli"] documentazione ONTAP per ulteriori informazioni. Annotare il nome utente e la password, da utilizzare nelle attività di configurazione della virtualizzazione.
. Raccogli l'IQN iSCSI della destinazione e gli UUID SVM per le seguenti risorse da utilizzare nelle attività di configurazione della virtualizzazione:
+
** La SVM
** Aggregato/i/Livello/i da utilizzare
** L'igroup con gli host OpenNebula
** IQN della destinazione iSCSI (in genere uguale all'IQN della SVM). L'amministratore della virtualizzazione può recuperare queste informazioni utilizzando il comando  `iscsiadm -m session` dopo aver effettuato l'accesso a uno degli host OpenNebula e aver individuato la destinazione iSCSI. +




[listing]
----
NETAPP_SVM="85c23687-d5d9-11f0-86c4-d039eac4d4b3"
NETAPP_AGGREGATES="6e8f9995-42dd-400a-a440-646639dc5d0b"
NETAPP_IGROUP="5ad9faf3-d62c-11f0-86c4-d039eac4d4b3"
NETAPP_TARGET="iqn.1992-08.com.netapp:sn.85c23687d5d911f086c4d039eac4d4b3:vs.6"
----
 TIP: System Manager displays the UUID in the URL when viewing the resource details.


== Attività finali dell'amministratore della virtualizzazione

Completare queste attività per configurare l'iSCSI Datastore su OpenNebula.

. Accedere tramite SSH a uno dei server frontend e scoprire tutti i portali iSCSI Lif fornendo uno degli indirizzi iSCSI data lif.
+
[source, shell]
----
iscsiadm -m discovery -t sendtargets -p <iscsi data lif address>
iscsiadm -m node
iscsiadm -m node -l
----
. Crea un file di configurazione in base al tipo di Datastore desiderato. Per l'elenco completo degli attributi, fare riferimento https://docs.opennebula.io/7.0/product/cluster_configuration/san_storage/netapp/#datastore-optional-attributes["OpenNebula NetApp SAN documentazione"]. Di seguito sono riportati file di esempio:
+
[role="tabbed-block"]
====
.Immagine
[source, shell]
----
$cat netapp-image.conf
NAME = "Image-NetApp-iSCSI"
TYPE = "IMAGE_DS"
DS_MAD = "netapp"
TM_MAD = "netapp"
DISK_TYPE = "BLOCK"
NETAPP_HOST = "<ontap_cluster_ip>"
NETAPP_USER = "<ontap_api_user>"
NETAPP_PASS = "<ontap_api_password>"
NETAPP_SVM = "<ontap_svm_uuid>"
NETAPP_AGGREGATES = "<ontap_aggregate_uuid>"
NETAPP_IGROUP = "<ontap_igroup_uuid>"
NETAPP_TARGET = "<ontap_iscsi_target_iqn>"
# Optional suffix to share SVM across multiple tenants
NETAPP_SUFFIX = "t1"
----
.Sistema
[source, shell]
----
$cat netapp-system.conf
NAME = "System-NetApp-iSCSI"
TYPE = "SYSTEM_DS"
TM_MAD = "netapp"
DISK_TYPE = "BLOCK"
NETAPP_HOST = "<ontap_cluster_ip>"
NETAPP_USER = "<ontap_api_user>"
NETAPP_PASS = "<ontap_api_password>"
NETAPP_SVM = "<ontap_svm_uuid>"
NETAPP_AGGREGATES = "<ontap_aggregate_uuid>"
NETAPP_IGROUP = "<ontap_igroup_uuid>"
NETAPP_TARGET = "<ontap_iscsi_target_iqn>"
# Optional suffix to share SVM across multiple tenants
NETAPP_SUFFIX = "t1"
----
====
. Esegui `onedatastore create <configuration file>`. Nota l'ID del datastore restituito dopo la creazione.
+
[]
====
onedatastore create netapp-system.conf ID: 105

====
. Verificare che il datastore sia stato creato correttamente eseguendo `onedatastore show <datastore_id>`.
. Scarica le app sul datastore delle immagini e crea una VM utilizzando i template per il provisioning sul datastore di sistema.
. Controlla le LUN create su ONTAP per i dischi immagine e i dischi delle macchine virtuali. La convenzione di naming utilizzata è la seguente:
+
.. Archivio dati immagine: one_<datastore_id>_<image_id>_<suffix> (volume), one_<datastore_id>_<image_id>_<suffix>_lun (LUN)
.. Archivio dati di sistema: one_<vm_id>_disk_<disk_id>_<suffix> (volume), one_<datastore_id>_<vm_id>_disk_<disk_id>_<suffix>_lun (LUN)
+
.Mostra esempio
[%collapsible]
====
image:opennebula-netapp-iscsi-002.png["LUN ONTAP per OpenNebula Images e VM"]

====



